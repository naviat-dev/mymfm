@page "/"
@using mymfm.Services
@using Microsoft.JSInterop
@inject FirebaseAuthService AuthService
@inject FirebaseService FirebaseService
@inject EmailVerificationService EmailVerificationService
@inject IJSRuntime JSRuntime

<PageTitle>Registration</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="registration-container">
	<MudPaper Elevation="8" Class="registration-card pa-8">
		<!-- Progress Indicator -->
		<MudProgressLinear Color="Color.Primary" Value="@ProgressPercentage" Class="mb-6" Size="Size.Medium"
			Rounded="true" />

		<MudText Typo="Typo.caption" Align="Align.Center" Class="mb-4">
			Question @(currentQuestion + 1) of @totalQuestions
		</MudText>

		<!-- Question Container with Animation -->
		<div class="question-container">
			@{
				var visibleQuestions = GetVisibleQuestions();
			}
			@foreach (var (question, index) in visibleQuestions.Select((q, i) => (q, i)))
			{
				<div class="question-slide @GetQuestionClass(index)"
					style="transform: translateX(@GetQuestionTransform(index));">

					<MudText Typo="Typo.h5" Align="Align.Center" Class="mb-6 question-text" Color="Color.Primary">
						@question.Text
					</MudText>

					@if (question.Type == QuestionType.Text)
					{
						<MudTextField @bind-Value="question.Answer" Label="@question.Label" Variant="Variant.Outlined"
							FullWidth="true" Immediate="true" OnKeyUp="HandleKeyPress" Class="question-input"
							Margin="Margin.Dense" />
					}
					else if (question.Type == QuestionType.Email)
					{
						<MudTextField @bind-Value="question.Answer" Label="@question.Label" Variant="Variant.Outlined"
							InputType="InputType.Email" FullWidth="true" Immediate="true" OnKeyUp="HandleKeyPress"
							Class="question-input" Margin="Margin.Dense" />
					}
					else if (question.Type == QuestionType.Date)
					{
						<MudDatePicker @bind-Date="question.DateAnswer" Label="@question.Label" Variant="Variant.Outlined"
							Class="question-input" Margin="Margin.Dense" />
					}
					else if (question.Type == QuestionType.Select)
					{
						<MudSelect @bind-Value="question.Answer" Label="@question.Label" Variant="Variant.Outlined"
							FullWidth="true" Class="question-input" Margin="Margin.Dense">
							@foreach (string option in question.Options)
							{
								<MudSelectItem Value="@option">@option</MudSelectItem>
							}
						</MudSelect>
					}
					else if (question.Type == QuestionType.Phone)
					{
						<MudTextField @bind-Value="question.Answer" Label="@question.Label" Variant="Variant.Outlined"
							InputType="InputType.Telephone" FullWidth="true" Immediate="true" OnKeyUp="HandleKeyPress"
							Class="question-input" Margin="Margin.Dense" />
					}
					else if (question.Type == QuestionType.Checkbox)
					{
						<MudCheckBox @bind-Value="question.BoolAnswer" Label="@question.Label" Color="Color.Primary"
							Class="question-input mt-4" />
					}
					else if (question.Type == QuestionType.ScrollableText)
					{
						var elementId = $"consent-{question.Id}";
						<MudPaper Class="scrollable-consent-box" Elevation="2">
							<div id="@elementId" class="consent-content" @onscroll="@(async () => await CheckScrollPosition(elementId, question))">
								<MudText Typo="Typo.body2" Style="white-space: pre-wrap;">
									@question.ScrollableContent
								</MudText>
							</div>
						</MudPaper>
						@if (!question.HasScrolledToBottom)
						{
							<MudText Typo="Typo.caption" Color="Color.Error" Class="mt-2">
								Please scroll to the bottom to continue
							</MudText>
						}
						else
						{
							<MudText Typo="Typo.caption" Color="Color.Success" Class="mt-2">
								✓ You have read the complete agreement
							</MudText>
						}
					}
					else if (question.Type == QuestionType.VerificationCode)
					{
						<MudStack Spacing="3">
							@if (!question.IsVerificationSent)
							{
								<MudAlert Severity="Severity.Info" Class="mb-4">
									We'll send a verification code to your email address to confirm it's valid.
								</MudAlert>
								<MudButton Variant="Variant.Filled" Color="Color.Primary"
									OnClick="@(async () => await SendVerificationCode(question))" Disabled="@question.IsSendingCode"
									FullWidth="true">
									@if (question.IsSendingCode)
									{
										<MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
										<MudText Class="ms-2">Sending code...</MudText>
									}
									else
									{
										<MudText>Send Verification Code</MudText>
									}
								</MudButton>
							}
							else
							{
								<MudAlert Severity="Severity.Success" Class="mb-4">
									Verification code sent! Check your email.
								</MudAlert>
								<MudTextField @bind-Value="question.Answer" Label="Enter 6-digit code" Variant="Variant.Outlined"
									FullWidth="true" Immediate="true" OnKeyUp="HandleKeyPress" Class="question-input"
									Margin="Margin.Dense" MaxLength="6" InputType="InputType.Number" />
								@if (!string.IsNullOrEmpty(question.VerificationError))
								{
									<MudAlert Severity="Severity.Error" Class="mt-2">
										@question.VerificationError
									</MudAlert>
								}
								@if (question.IsVerified)
								{
									<MudAlert Severity="Severity.Success" Class="mt-2">
										✓ Email verified successfully!
									</MudAlert>
								}
								<MudButton Variant="Variant.Text" Color="Color.Secondary"
									OnClick="@(async () => await SendVerificationCode(question))" Disabled="@question.IsSendingCode"
									Class="mt-2">
									Resend Code
								</MudButton>
							}
						</MudStack>
					}

					@if (!string.IsNullOrEmpty(question.HelperText))
					{
						<MudText Typo="Typo.caption" Class="mt-2" Color="Color.Secondary">
							@question.HelperText
						</MudText>
					}
				</div>
			}
		</div>

		<!-- Navigation Buttons -->
		<MudStack Row="true" Justify="Justify.SpaceBetween" Class="mt-8">
			<MudButton Variant="Variant.Text" StartIcon="Icons.Material.Filled.ArrowBack" OnClick="PreviousQuestion"
				Disabled="@(currentQuestion == 0)" Color="Color.Default">
				Back
			</MudButton>

			@if (currentQuestion < totalQuestions - 1)
			{
				<MudButton Variant="Variant.Filled" EndIcon="Icons.Material.Filled.ArrowForward" OnClick="NextQuestion"
					Disabled="@(!IsCurrentQuestionValid())" Color="Color.Primary" Size="Size.Large">
					Next
				</MudButton>
			}
			else
			{
				<MudButton Variant="Variant.Filled" EndIcon="Icons.Material.Filled.CheckCircle" OnClick="SubmitRegistration"
					Disabled="@(!IsCurrentQuestionValid())" Color="Color.Success" Size="Size.Large">
					Complete
				</MudButton>
			}
		</MudStack>
	</MudPaper>
</MudContainer>

<!-- Success Dialog -->
<MudDialog @bind-Visible="showSuccessDialog">
	<DialogContent>
		<MudStack AlignItems="AlignItems.Center" Spacing="4" Class="pa-4">
			<MudIcon Icon="Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Large"
				Class="success-icon" />
			<MudText Typo="Typo.h4" Align="Align.Center">
				Registration Complete!
			</MudText>
			<MudText Typo="Typo.body1" Align="Align.Center">
				Thank you for registering!
			</MudText>
		</MudStack>
	</DialogContent>
	<DialogActions>
		<MudButton Color="Color.Primary" Variant="Variant.Filled" FullWidth="true" OnClick="ResetForm">
			Start New Registration
		</MudButton>
	</DialogActions>
</MudDialog>

<style>
	.registration-container {
		min-height: 80vh;
		display: flex;
		align-items: center;
		justify-content: center;
		padding: 2rem 0;
	}

	.registration-card {
		border-radius: 24px !important;
		box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2) !important;
		min-height: 500px;
		display: flex;
		flex-direction: column;
		justify-content: space-between;
	}

	.question-container {
		position: relative;
		min-height: 280px;
		overflow: hidden;
		perspective: 1000px;
	}

	.question-slide {
		position: absolute;
		width: 100%;
		opacity: 0;
		transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
		pointer-events: none;
	}

	.question-slide.active {
		position: relative;
		opacity: 1;
		transform: translateX(0) !important;
		pointer-events: auto;
	}

	.question-slide.exiting-left {
		opacity: 0;
		transform: translateX(-100%) !important;
	}

	.question-slide.exiting-right {
		opacity: 0;
		transform: translateX(100%) !important;
	}

	.question-text {
		font-weight: 500 !important;
		line-height: 1.4 !important;
		animation: fadeInScale 0.5s cubic-bezier(0.4, 0, 0.2, 1);
	}

	.question-input {
		animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
	}

	.success-icon {
		animation: successBounce 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
	}

	.mud-progress-linear {
		height: 8px !important;
	}

	@@keyframes fadeInScale {
		from {
			opacity: 0;
			transform: scale(0.95);
		}

		to {
			opacity: 1;
			transform: scale(1);
		}
	}

	@@keyframes fadeInUp {
		from {
			opacity: 0;
			transform: translateY(20px);
		}

		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	@@keyframes successBounce {
		0% {
			transform: scale(0);
			opacity: 0;
		}

		50% {
			transform: scale(1.2);
		}

		100% {
			transform: scale(1);
			opacity: 1;
		}
	}

	.scrollable-consent-box {
		border-radius: 8px !important;
		overflow: hidden;
		margin-top: 1rem;
	}

	.consent-content {
		max-height: 300px;
		overflow-y: auto;
		padding: 1.5rem;
		line-height: 1.6;
	}

	.consent-content::-webkit-scrollbar {
		width: 8px;
	}

	.consent-content::-webkit-scrollbar-track {
		background: #f1f1f1;
	}

	.consent-content::-webkit-scrollbar-thumb {
		background: #888;
		border-radius: 4px;
	}

	.consent-content::-webkit-scrollbar-thumb:hover {
		background: #555;
	}

	/* Mobile responsiveness */
	@@media (max-width: 600px) {
		.registration-card {
			margin: 1rem;
			padding: 1.5rem !important;
		}

		.question-text {
			font-size: 1.25rem !important;
		}

		.consent-content {
			max-height: 250px;
			padding: 1rem;
		}
	}
</style>

@code {
	private int currentQuestion = 0;
	private int totalQuestions => GetVisibleQuestions().Count;
	private bool showSuccessDialog = false;

	private double ProgressPercentage => totalQuestions > 0 ? ((double)(currentQuestion + 1) / totalQuestions) * 100 : 0;

	private List<Question> questions = [
		new Question
		{
			Id = "country",
			Text = "Country of residence",
			Label = "Country",
			Type = QuestionType.Select,
			Options = ["United States of America", "Canada", "Caribbean"],
			Required = true
		},
		new Question
		{
			Id = "stateUS",
			Text = "State of residence",
			Label = "State",
			Type = QuestionType.Select,
			Options = ["Alabama", "Alaska", "Arizona", "Arkansas", "California", "Colorado", "Connecticut", "Delaware", "Florida",
			"Georgia", "Hawaii", "Idaho", "Illinois", "Indiana", "Iowa", "Kansas", "Kentucky", "Louisiana", "Maine", "Maryland",
			"Massachusetts", "Michigan", "Minnesota", "Mississippi", "Missouri", "Montana", "Nebraska", "Nevada", "New Hampshire",
			"New Jersey", "New Mexico", "New York", "North Carolina", "North Dakota", "Ohio", "Oklahoma", "Oregon", "Pennsylvania",
			"Rhode Island", "South Carolina", "South Dakota", "Tennessee", "Texas", "Utah", "Vermont", "Virginia", "Washington",
			"West Virginia", "Wisconsin", "Wyoming"],
			Required = true
		},
		new Question
		{
			Id = "stateCA",
			Text = "State of residence",
			Label = "State",
			Type = QuestionType.Select,
			Options = ["Alberta", "British Columbia", "Manitoba", "New Brunswick", "Newfoundland and Labrador", "Northwest Territories",
			"Nova Scotia", "Nunavut", "Ontario", "Prince Edward Island", "Quebec", "Saskatchewan", "Yukon"],
			Required = true
		},
		new Question
		{
			Id = "firstName",
			Text = "First Name",
			Label = "First Name",
			Type = QuestionType.Text,
			Required = true
		},
		new Question
		{
			Id = "lastName",
			Text = "Last Name",
			Label = "Last Name",
			Type = QuestionType.Text,
			Required = true
		},
		new Question
		{
			Id = "email",
			Text = "Email",
			Label = "Email",
			Type = QuestionType.Email,
			Required = true
		},
		new Question
		{
Id = "emailVerification",
Text = "Verify Your Email",
Label = "Verification Code",
Type = QuestionType.VerificationCode,
Required = true
},
new Question
{
			Id = "phone",
			Text = "Phone Number",
			Label = "Phone Number",
			Type = QuestionType.Phone,
			Required = true
		},
		new Question
		{
			Id = "gender",
			Text = "Gender",
			Label = "Gender",
			Type = QuestionType.Select,
			Options = ["Male", "Female"],
			Required = true
		},
		new Question
		{
			Id = "age",
			Text = "Age Range",
			Label = "Age",
			Type = QuestionType.Select,
			Options = ["3-6", "7-11", "12-17", "18-24", "25-34", "35-44", "45+"],
			Required = true
		},
		new Question
		{
			Id = "parentalConsentText",
			Text = "Parental Consent, Release, and Disciplinary Agreement",
			Label = "Please read the entire agreement",
			Type = QuestionType.ScrollableText,
			ScrollableContent = @"PARENTAL CONSENT, RELEASE, AND DISCIPLINARY AGREEMENT

1.0 Parental Consent and Liability Release

I/We, the undersigned parent(s) or legal guardian(s), hereby grant permission for my/our child or youth (""Participant"") to participate in youth programs, activities, events, and travel sponsored by Mountain of Fire and Miracles Ministries (MFM).

In consideration of the Participant's acceptance and participation in activities scheduled from July 16, 2026 through July 19, 2026, I/we, on behalf of myself/ourselves and the Participant, hereby release, waive, discharge, and covenant not to sue Mountain of Fire and Miracles Ministries, its directors, officers, employees, agents, volunteers, and affiliates from any and all claims, demands, actions, or causes of action, whether known or unknown, arising out of or related to participation in such programs, including but not limited to personal injury, illness, death, property damage, or associated expenses.

I/We further acknowledge and assume all risks, both known and unknown, associated with the Participant's involvement in recreational, ministry, travel, and work-related activities.

Authorization is hereby granted for MFM to provide or arrange transportation, meals, lodging, and supervision as deemed necessary for the Participant.

I/We agree to indemnify and hold harmless Mountain of Fire and Miracles Ministries and its representatives from any liability, loss, or expense (including reasonable attorney's fees) arising from the negligent, willful, or intentional acts of the Participant.

2.0 Medical Authorization

If the Participant is under the age of eighteen (18), I/we hereby authorize Mountain of Fire and Miracles Ministries to secure medical treatment, including emergency care, for the Participant in the event of illness or injury.

I/We accept full financial responsibility for all medical expenses incurred. Should it become necessary for the Participant to return home due to medical reasons, disciplinary action, or other circumstances, I/we agree to assume all associated transportation costs.

3.0 Consent and Disciplinary Agreement

I/We consent to the Participant's voluntary participation in the MFM Americas & Caribbean Youth Convention, to be held from July 16 through July 19, 2026.

I/We acknowledge that participation is voluntary and agree not to hold Mountain of Fire and Miracles Ministries liable for any loss or injury arising from participation, except as prohibited by law.

I/We further acknowledge that the Participant is required to abide by all rules, policies, and behavioral standards established by MFM, its leaders, and supervisory personnel.

I/We understand that serious misconduct or significant violations of these rules may result in dismissal from the program. In such cases:
• I/We assume responsibility for return transportation costs
• I/We acknowledge that no refund will be issued

Such action will be taken only in exceptional circumstances and after reasonable consultation with the Participant's pastors, parents, or guardians.

4.0 Acknowledgment and Agreement

By scrolling to the bottom and proceeding, I/We certify that:
• I/We have read this document in its entirety
• I/We fully understand its contents
• I/We voluntarily agree to all terms and conditions stated herein",
			Required = true
		},
		new Question
		{
			Id = "medicalConditions",
			Text = "Medical conditions (if any)",
			Label = "Medical conditions (if any)",
			Type = QuestionType.Text,
			HelperText = "Leave blank if none",
			Required = false
		},
		new Question
		{
			Id = "allergies",
			Text = "Allergies (if any)",
			Label = "Allergies (if any)",
			Type = QuestionType.Text,
			HelperText = "Leave blank if none",
			Required = false
		},
		new Question
		{
			Id = "medications",
			Text = "Medications (if any)",
			Label = "Medications (if any)",
			Type = QuestionType.Text,
			HelperText = "Leave blank if none",
			Required = false
		},
		new Question
		{
			Id = "foodAllergies",
			Text = "Food allergies (if any)",
			Label = "Food allergies (if any)",
			Type = QuestionType.Text,
			HelperText = "Leave blank if none",
			Required = false
		},
		new Question
		{
			Id = "consentCheckbox",
			Text = "Do you agree to the Terms and Conditions?",
			Label = "I agree to the Terms and Conditions stated above",
			Type = QuestionType.Checkbox,
			Required = true
		},
		new Question
		{
			Id = "parentName",
			Text = "Parent/Guardian Full Name",
			Label = "Parent/Guardian Full Name",
			Type = QuestionType.Text,
			Required = true
		},
		new Question
		{
			Id = "childName",
			Text = "Child's Full Name",
			Label = "Child's Full Name",
			Type = QuestionType.Text,
			Required = true
		},
		new Question
		{
			Id = "maritalStatus",
			Text = "Marital Status",
			Label = "Marital Status",
			Type = QuestionType.Select,
			Options = ["Single", "Married"],
			Required = true
		},
		new Question
		{
			Id = "collegeAffiliation",
			Text = "Are you a college student, faculty, or staff?",
			Label = "College Affiliation",
			Type = QuestionType.Select,
			Options = ["Yes", "No"],
			Required = true
		},
		new Question
		{
			Id = "schoolName",
			Text = "School Name",
			Label = "School Name",
			Type = QuestionType.Text,
			Required = true
		},
		new Question
		{
			Id = "campusCommunity",
			Text = "What is your role?",
			Label = "Campus Role",
			Type = QuestionType.Select,
			Options = ["College Student", "Faculty", "Staff"],
			Required = true
		}
	];

	private bool ShouldShowQuestion(string questionId)
	{
		var country = questions.FirstOrDefault(q => q.Id == "country")?.Answer;
		var age = questions.FirstOrDefault(q => q.Id == "age")?.Answer;
		var collegeAffiliation = questions.FirstOrDefault(q => q.Id == "collegeAffiliation")?.Answer;

		return questionId switch
		{
			"stateUS" => country == "United States of America",
			"stateCA" => country == "Canada",
			"parentalConsentText" => age == "3-6" || age == "7-11" || age == "12-17",
			"medicalConditions" => age == "3-6" || age == "7-11" || age == "12-17",
			"allergies" => age == "3-6" || age == "7-11" || age == "12-17",
			"medications" => age == "3-6" || age == "7-11" || age == "12-17",
			"foodAllergies" => age == "3-6" || age == "7-11" || age == "12-17",
			"consentCheckbox" => age == "3-6" || age == "7-11" || age == "12-17",
			"parentName" => age == "3-6" || age == "7-11" || age == "12-17",
			"childName" => age == "3-6" || age == "7-11" || age == "12-17",
			"maritalStatus" => age == "18-24" || age == "25-34" || age == "35-44" || age == "45+",
			"collegeAffiliation" => age == "18-24" || age == "25-34" || age == "35-44" || age == "45+",
			"schoolName" => collegeAffiliation == "Yes",
			"campusCommunity" => collegeAffiliation == "Yes",
			_ => true
		};
	}

	private List<Question> GetVisibleQuestions()
	{
		return questions.Where(q => ShouldShowQuestion(q.Id)).ToList();
	}

	private string GetQuestionClass(int index)
	{
		if (index == currentQuestion)
			return "active";

		return "";
	}

	private string GetQuestionTransform(int index)
	{
		if (index == currentQuestion)
			return "0";

		if (index < currentQuestion)
			return "-100%";

		return "100%";
	}

	private void NextQuestion()
	{
		if (currentQuestion < totalQuestions - 1 && IsCurrentQuestionValid())
		{
			currentQuestion++;
		}
	}

	private void PreviousQuestion()
	{
		if (currentQuestion > 0)
		{
			currentQuestion--;
		}
	}

	private bool IsCurrentQuestionValid()
	{
		var visibleQuestions = GetVisibleQuestions();
		if (currentQuestion >= visibleQuestions.Count) return false;

		Question question = visibleQuestions[currentQuestion];

		if (!question.Required)
			return true;

		return question.Type switch
		{
			QuestionType.Text => !string.IsNullOrWhiteSpace(question.Answer),
			QuestionType.Email => !string.IsNullOrWhiteSpace(question.Answer) && question.Answer.Contains("@"),
			QuestionType.Phone => !string.IsNullOrWhiteSpace(question.Answer),
			QuestionType.Date => question.DateAnswer.HasValue,
			QuestionType.Select => !string.IsNullOrWhiteSpace(question.Answer),
			QuestionType.Checkbox => question.BoolAnswer,
			QuestionType.ScrollableText => question.HasScrolledToBottom,
			QuestionType.VerificationCode => question.IsVerified,
			_ => false
		};
	}

	private async Task HandleKeyPress(KeyboardEventArgs e)
	{
		if (e.Key == "Enter" && IsCurrentQuestionValid())
		{
			if (currentQuestion < totalQuestions - 1)
			{
				NextQuestion();
			}
			else
			{
				await SubmitRegistration();
			}
		}
	}

	private async Task SubmitRegistration()
	{
		if (IsCurrentQuestionValid())
		{
			try
			{
				await AuthService.SignInAnonymouslyAsync();

				var formData = new Dictionary<string, object>();
				var visibleQuestions = GetVisibleQuestions();
				foreach (var question in visibleQuestions)
				{
					formData[question.Id] = question.Type switch
					{
						QuestionType.Date => question.DateAnswer?.ToString("o") ?? "",
						QuestionType.Checkbox => question.BoolAnswer,
						_ => question.Answer ?? ""
					};
				}
				formData["timestamp"] = DateTime.UtcNow.ToString("o");

				await FirebaseService.SaveDataAsync("form-responses", formData);
				showSuccessDialog = true;
			}
			catch (Exception ex)
			{
				Console.WriteLine($"Error submitting form: {ex.Message}");
			}
		}
	}

	private void ResetForm()
	{
		foreach (Question question in questions)
		{
			question.Answer = string.Empty;
			question.DateAnswer = null;
			question.BoolAnswer = false;
			question.HasScrolledToBottom = false;
		}
		currentQuestion = 0;
		showSuccessDialog = false;
	}

	private async Task HandleScroll(Microsoft.AspNetCore.Components.Web.WheelEventArgs e, Question question)
	{
		// This is a placeholder - actual scroll detection happens via JavaScript interop
		// For now, we'll mark as scrolled after any scroll event
		await Task.Delay(100);
		question.HasScrolledToBottom = true;
		StateHasChanged();
	}

	private async Task CheckScrollPosition(string elementId, Question question)
	{
		try
		{
			var hasScrolledToBottom = await JSRuntime.InvokeAsync<bool>("checkScrollPosition", elementId);
			if (hasScrolledToBottom && !question.HasScrolledToBottom)
			{
				question.HasScrolledToBottom = true;
				StateHasChanged();
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error checking scroll position: {ex.Message}");
		}
	}

	private async Task SendVerificationCode(Question question)
	{
		try
		{
			var emailQuestion = questions.FirstOrDefault(q => q.Id == "email");
			if (emailQuestion == null || string.IsNullOrWhiteSpace(emailQuestion.Answer))
			{
				question.VerificationError = "Email not found. Please go back and enter your email.";
				return;
			}

			question.IsSendingCode = true;
			question.VerificationError = string.Empty;
			StateHasChanged();

			var success = await EmailVerificationService.SendVerificationCodeAsync(emailQuestion.Answer);

			if (success)
			{
				question.IsVerificationSent = true;
				question.VerificationError = string.Empty;
			}
			else
			{
				question.VerificationError = "Failed to send verification code. Please try again.";
			}
		}
		catch (Exception ex)
		{
			question.VerificationError = $"Error sending code: {ex.Message}";
			Console.WriteLine($"Error sending verification code: {ex.Message}");
		}
		finally
		{
			question.IsSendingCode = false;
			StateHasChanged();
		}
	}

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			// Watch for changes to verification code and verify automatically
			StateHasChanged();
		}

		// Check if we're on the verification question and code was entered
		var visibleQuestions = GetVisibleQuestions();
		if (currentQuestion < visibleQuestions.Count)
		{
			var question = visibleQuestions[currentQuestion];
			if (question.Type == QuestionType.VerificationCode &&
			!question.IsVerified &&
			question.IsVerificationSent &&
			!string.IsNullOrWhiteSpace(question.Answer) &&
			question.Answer.Length == 6)
			{
				await VerifyCode(question);
			}
		}
	}

	private async Task VerifyCode(Question question)
	{
		if (question.IsVerifying) return; // Prevent multiple simultaneous verifications

		try
		{
			question.IsVerifying = true;
			var emailQuestion = questions.FirstOrDefault(q => q.Id == "email");
			if (emailQuestion == null || string.IsNullOrWhiteSpace(emailQuestion.Answer))
			{
				question.VerificationError = "Email not found.";
				return;
			}

			await Task.Delay(100); // Small delay to debounce

			var (isValid, error) = await EmailVerificationService.VerifyCodeAsync(emailQuestion.Answer, question.Answer);

			if (isValid)
			{
				question.IsVerified = true;
				question.VerificationError = string.Empty;
			}
			else
			{
				question.VerificationError = error ?? "Invalid or expired code. Please try again.";
				question.IsVerified = false;
			}

			StateHasChanged();
		}
		finally
		{
			question.IsVerifying = false;
		}
	}

	public class Question
	{
		public string Id { get; set; } = string.Empty;
		public string Text { get; set; } = string.Empty;
		public string Label { get; set; } = string.Empty;
		public QuestionType Type { get; set; }
		public string Answer { get; set; } = string.Empty;
		public DateTime? DateAnswer { get; set; }
		public bool BoolAnswer { get; set; }
		public List<string> Options { get; set; } = [];
		public string HelperText { get; set; } = string.Empty;
		public bool Required { get; set; }
		public string ScrollableContent { get; set; } = string.Empty;
		public bool HasScrolledToBottom { get; set; } = false;
		// Email verification properties
		public bool IsVerificationSent { get; set; } = false;
		public bool IsVerified { get; set; } = false;
		public bool IsSendingCode { get; set; } = false;
		public bool IsVerifying { get; set; } = false;
		public string VerificationError { get; set; } = string.Empty;
	}

	public enum QuestionType
	{
		Text,
		Email,
		Phone,
		Date,
		Select,
		Checkbox,
		ScrollableText,
		VerificationCode
	}
}